<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Memory Sync</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background: #0d1117; color: #e6edf3; padding: 2rem; max-width: 800px; margin: 0 auto; }
    h1 { margin-bottom: 0.5rem; font-size: 1.8rem; }
    .subtitle { color: #8b949e; margin-bottom: 2rem; }
    .card { background: #161b22; border: 1px solid #30363d; border-radius: 8px; padding: 1.5rem; margin-bottom: 1rem; }
    .card h2 { font-size: 1.1rem; margin-bottom: 1rem; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 0.75rem; }
    .stat { background: #0d1117; padding: 0.75rem; border-radius: 6px; text-align: center; }
    .stat .value { font-size: 1.5rem; font-weight: 700; color: #58a6ff; }
    .stat .label { font-size: 0.8rem; color: #8b949e; margin-top: 0.25rem; }
    .upload-zone { border: 2px dashed #30363d; border-radius: 8px; padding: 2rem; text-align: center; cursor: pointer; transition: border-color 0.2s; }
    .upload-zone:hover { border-color: #58a6ff; }
    .upload-zone.dragover { border-color: #58a6ff; background: rgba(88,166,255,0.05); }
    input[type="file"] { display: none; }
    select, button { background: #21262d; color: #e6edf3; border: 1px solid #30363d; padding: 0.5rem 1rem; border-radius: 6px; cursor: pointer; font-size: 0.9rem; }
    button { background: #238636; border-color: #238636; font-weight: 600; }
    button:hover { background: #2ea043; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn-sync { background: #1f6feb; border-color: #1f6feb; }
    .btn-sync:hover { background: #388bfd; }
    .row { display: flex; gap: 0.75rem; align-items: center; margin-top: 0.75rem; }
    .log { background: #0d1117; padding: 1rem; border-radius: 6px; margin-top: 1rem; font-family: monospace; font-size: 0.85rem; white-space: pre-wrap; max-height: 200px; overflow-y: auto; display: none; }
    .log.visible { display: block; }
    .log .success { color: #3fb950; }
    .log .error { color: #f85149; }
    .log .info { color: #8b949e; }
  </style>
</head>
<body>
  <h1>üß† Memory Sync</h1>
  <p class="subtitle">Sync chat platforms to PostgreSQL</p>

  <div class="card">
    <h2>üìä Database Stats</h2>
    <div class="stats-grid" id="stats">
      <div class="stat"><div class="value" id="total">‚Äî</div><div class="label">Total Messages</div></div>
    </div>
  </div>

  <div class="card">
    <h2>üì§ Upload Files</h2>
    <div class="row">
      <select id="uploadType">
        <option value="imessage">iMessage (chat.db)</option>
        <option value="whatsapp">WhatsApp (chat export .txt)</option>
      </select>
    </div>
    <div class="upload-zone" id="dropZone" onclick="document.getElementById('fileInput').click()">
      <p>üìÅ Drop file here or click to select</p>
      <input type="file" id="fileInput" accept=".db,.sqlite,.txt">
    </div>
    <div class="log" id="uploadLog"></div>
  </div>

  <div class="card">
    <h2>üîÑ Live Syncs</h2>
    <div id="syncServices"></div>
    <div class="log" id="syncLog"></div>
  </div>

  <script>
    async function loadStats() {
      try {
        const res = await fetch('/api/stats');
        const data = await res.json();
        const grid = document.getElementById('stats');
        grid.innerHTML = `<div class="stat"><div class="value">${Number(data.total).toLocaleString()}</div><div class="label">Total Messages</div></div>`;
        for (const src of data.sources) {
          grid.innerHTML += `<div class="stat"><div class="value">${Number(src.count).toLocaleString()}</div><div class="label">${src.source}</div></div>`;
        }
      } catch (e) { console.error(e); }
    }

    function log(id, msg, cls = 'info') {
      const el = document.getElementById(id);
      el.classList.add('visible');
      el.innerHTML += `<span class="${cls}">${msg}</span>\n`;
      el.scrollTop = el.scrollHeight;
    }

    // File upload
    const dropZone = document.getElementById('dropZone');
    const fileInput = document.getElementById('fileInput');

    dropZone.addEventListener('dragover', e => { e.preventDefault(); dropZone.classList.add('dragover'); });
    dropZone.addEventListener('dragleave', () => dropZone.classList.remove('dragover'));
    dropZone.addEventListener('drop', e => { e.preventDefault(); dropZone.classList.remove('dragover'); uploadFile(e.dataTransfer.files[0]); });
    fileInput.addEventListener('change', () => { if (fileInput.files[0]) uploadFile(fileInput.files[0]); });

    async function uploadFile(file) {
      const type = document.getElementById('uploadType').value;
      log('uploadLog', `Uploading ${file.name} as ${type}...`);
      const form = new FormData();
      form.append('file', file);
      try {
        const res = await fetch(`/api/upload/${type}`, { method: 'POST', body: form });
        const data = await res.json();
        if (data.ok) {
          log('uploadLog', `‚úÖ ${data.inserted} messages inserted`, 'success');
        } else {
          log('uploadLog', `‚ùå ${data.error}`, 'error');
        }
        loadStats();
      } catch (e) {
        log('uploadLog', `‚ùå ${e.message}`, 'error');
      }
    }

    async function runSync(platform) {
      log('syncLog', `Starting ${platform} sync...`);
      try {
        const res = await fetch(`/api/sync/${platform}`, { method: 'POST' });
        const data = await res.json();
        if (data.ok) {
          log('syncLog', `‚úÖ ${platform}: ${data.inserted} new messages`, 'success');
        } else {
          log('syncLog', `‚ùå ${platform}: ${data.error}`, 'error');
        }
        loadStats(); loadSyncStatus();
      } catch (e) {
        log('syncLog', `‚ùå ${e.message}`, 'error');
        loadSyncStatus();
      }
    }

    const SERVICES = [
      { id: 'discord', label: 'Discord', icon: 'üí¨' },
      { id: 'slack', label: 'Slack', icon: 'üì®' },
      { id: 'anthropic', label: 'Anthropic', icon: 'ü§ñ' },
      { id: 'openai', label: 'OpenAI', icon: 'üß†' },
    ];

    function renderServices(statuses) {
      const statusMap = {};
      for (const s of statuses) statusMap[s.service] = s;
      const el = document.getElementById('syncServices');
      el.innerHTML = SERVICES.map(svc => {
        const st = statusMap[svc.id];
        const lastSync = st?.last_sync_at ? new Date(st.last_sync_at).toLocaleString() : 'Never';
        const status = st?.is_running ? 'üîÑ Running' : st?.last_status === 'ok' ? '‚úÖ OK' : st?.last_status === 'error' ? '‚ùå Error' : '‚è∏Ô∏è Idle';
        const inserted = st?.last_inserted || 0;
        const total = st?.total_synced || 0;
        return `<div style="display:flex;justify-content:space-between;align-items:center;padding:0.5rem 0;border-bottom:1px solid #21262d">
          <span>${svc.icon} <strong>${svc.label}</strong> ‚Äî ${status} ‚Äî Last: ${lastSync} (${inserted} last / ${total} total)</span>
          <button class="btn-sync" onclick="runSync('${svc.id}')" ${st?.is_running ? 'disabled' : ''}>Sync</button>
        </div>`;
      }).join('');
    }

    async function loadSyncStatus() {
      try { const res = await fetch('/api/sync/status'); renderServices(await res.json()); }
      catch { renderServices([]); }
    }

    loadStats();
    loadSyncStatus();
    setInterval(() => { loadStats(); loadSyncStatus(); }, 10000);
  </script>
</body>
</html>
